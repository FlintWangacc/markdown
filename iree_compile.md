# IREE COMPILE
## executable
target platform executable seems generated by `MaterializeInterfacesPass` after stream dialect.

## stream dialect
stream dialect seems to consider execution stream. Some stream run on virtual machine. Some stream run on device.

## current debug
```bash
third_party/llvm-project/mlir/lib/Pass/Pass.cpp:549
third_party/llvm-project/mlir/lib/IR/MLIRContext.cpp:598
```
## Pass
### ConvertToFlow
ConvertToFlow contains several rewrite pattern
| Pattern | function|
|----------|---------|
|ConvertLinalgFillPattern| Converts linalg.fill ops into flow.tensor.splat ops.|
|ConvertTensorBitcastPattern||
|ConvertTensorExtBitcastPattern||
|ConvertTensorCastPattern||
|ConvertTensorConcatPattern||
|ConvertTensorExtractPattern||
|ConvertTensorExtractSlicePattern||
|ConvertTensorInsertSlicePattern|Convert tensor.insert_slice ops into flow.tensor.update ops where possible.|
|ConvertTensorFromElementsPattern||
|ConvertTensorDialectReshapeOpPattern|Convert tensor.reshape ops into flow.tensor.reshape ops where possible.|
|ConvertTensorReshapePattern<tensor::CollapseShapeOp>|Converts linalg.tensor_reshape operations into flow.tensor.reshape operations|
|ConvertTensorReshapePattern<tensor::ExpandShapeOp>||
#### TensorPadToTensorInsertSlicePass
```bash
Full path: /home/hmsjwzb/work/pytorch/iree/compiler/src/iree/compiler/DispatchCreation/TensorPadToTensorInsertSlice.cpp
Line: 96
```
##### CanonicalizePass
file: compiler/src/iree/compiler/Dialect/Flow/Transforms/Canonicalize.cpp
line: 110

## How iree create executable kernel

### FormDispatchRegionsPass
location:
```bash
compiler/src/iree/compiler/DispatchCreation/FormDispatchRegions.cpp
FormDispatchRegionsPass::runOnOperation

Full path: /home/hmsjwzb/work/pytorch/iree/compiler/src/iree/compiler/DispatchCreation/FormDispatchRegions.cpp
Line: 1011
```

## How iree change the mlir kernel to llvm ir kernel
### passname
TranslateTargetExecutableVariantsPass

### location
```bash
Full path: /home/hmsjwzb/work/pytorch/iree/compiler/src/iree/compiler/Dialect/HAL/Transforms/TranslateExecutables.cpp
Line: 76
```
### subpass
1. HoistExecutableObjectsPass
	- compiler/src/iree/compiler/Dialect/HAL/Transforms/HoistExecutableObjects.cpp
2. pipeline
	- LowerExecutableUsingTransformDialectPass
		- `compiler/src/iree/compiler/Codegen/Common/LowerExecutableUsingTransformDialect.cpp`
		- passline
			-  LLVMGPULowerExecutableTargetPass

## Tricks
### How to disable multi-thread in mlir
  Set the flag specifying if multi-threading is disabled by the context.
   The command line debugging flag `--mlir-disable-threading` is overriding
   this call and making it a no-op!

## addGPUTileAndFusePassPipeline
<ol start="0">
  <li>Step 0: Apply any user annotated lowering strategies. This runs first as steps 1 - 4 are essentially applying patterns based on the lowering config, so a custom strategy runs first circumventing that.</li>
  <li>Step 1: Promote matmul operands and pack to intrinsic shapes.</li>
  <li>Step 1.5: Expand result shapes of MultiMmaOps before tiling, and propagate reshapes to the function boundary.u
  <li>Step 2: Tile and fuse tileable ops to reduction loops.</li>
  <li>Step 3: Decompose pack and unpack ops and propagate the resulting reshapes.</li>
  <li>Step 3.5: Expand the inner dimensions of MultiMma ops in preparation for distribution to lanes.</li>
  <li>Step 4: Tile and fuse tileable ops to subgroups/threads.</li>
  <li>Step 4.5:Things that need to happen right after distribution to threads. </li>
  <li>Step 5:Greedily fuse parallel loops and hoist from serial loops.</li>
  <li>Step 6: Lower special ops and vectorize.</li>
  <li>Step 7: Bufferize</li>
  <li>Step 8. Resolve remaining parallel loops.</li>
  <li>Step 9:Remaining post-bufferization optimizations/lowerings.</li>
</ol>
<!--stackedit_data:
eyJoaXN0b3J5IjpbNzk4MjQwNjY3XX0=
-->